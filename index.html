<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TF2 Colored Chat Creator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tf2-bg: #1a1a1a;
            --tf2-text: #d8d8d8;
            --tf2-header: #ff9900;
            --tf2-ui-bg: #2a2c30;
            --tf2-ui-bg-darker: #202225;
            --tf2-ui-border: #ff7700;
            --tf2-sidebar-bg: #111111;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* --- Keyframe Animations --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        body {
            /* Use Oswald for headers, Roboto Mono for the rest */
            font-family: 'Roboto Mono', monospace;
            background-color: var(--tf2-bg);
            color: var(--tf2-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        h1, h2, h3 {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }
        
        /* --- Scrollbar Styling --- */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--tf2-ui-bg-darker);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--tf2-ui-border);
        }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 240px;
            height: 100vh;
            background-color: var(--tf2-sidebar-bg);
            border-right: 2px solid var(--tf2-ui-border);
            padding: 20px;
            flex-shrink: 0;
            animation: slideInFromLeft 0.5s ease-out;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            color: var(--tf2-header);
            font-size: 1.5rem;
            margin-bottom: 25px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav li {
            margin-bottom: 15px;
        }

        .sidebar nav a {
            color: var(--tf2-text);
            text-decoration: none;
            font-size: 1rem;
            padding: 8px 12px;
            display: block;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
        }

        .sidebar nav a:hover {
            background-color: var(--tf2-ui-border);
            color: var(--tf2-bg);
            transform: translateX(5px);
            letter-spacing: 0.5px;
        }

        .sidebar nav a.active {
            background-color: var(--tf2-ui-bg);
            color: var(--tf2-header);
            font-weight: bold;
        }

        /* --- History Section --- */
        .history-section {
            margin-top: 30px;
            flex-grow: 1;
            overflow-y: auto;
            border-top: 1px solid #444;
            padding-top: 15px;
        }

        .history-section h3 {
            font-size: 0.9rem;
            color: var(--tf2-header);
            margin-bottom: 10px;
        }

        .history-list {
            list-style: none;
            font-size: 0.8rem;
        }

        .history-item {
            padding: 8px;
            background: #222;
            border-radius: 3px;
            margin-bottom: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
            border-left: 2px solid transparent;
        }

        .history-item:hover {
            background: #333;
            border-left: 2px solid var(--tf2-ui-border);
        }

        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            height: 100vh;
            overflow-y: auto;
        }
        
        h1 {
            color: var(--tf2-header);
            text-align: center;
            font-weight: 700;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
            animation: fadeInUp 0.5s ease-out 0.1s backwards;
        }

        .instructions {
            background-color: var(--tf2-ui-bg);
            border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 25px;
            font-size: 14px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeInUp 0.5s ease-out 0.2s backwards;
        }

        .instructions h3 {
            color: var(--tf2-header);
            margin-top: 0;
            font-size: 1.2rem;
        }

        .instructions .special-char {
            display: inline-block;
            background-color: #444;
            color: #ff9900;
            padding: 0 5px;
            border-radius: 3px;
            font-family: monospace;
            margin: 0 3px;
        }
        
        .app-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .ui-panel {
            background-color: var(--tf2-ui-bg);
            border: 1px solid #444;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 20px;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            margin-bottom: 25px;
        }
        
        .ui-panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
        }

        /* Staggered animation for the panels */
        .left-column .ui-panel {
            animation: fadeInUp 0.5s ease-out 0.3s backwards;
        }
        .right-column .ui-panel {
            animation: fadeInUp 0.5s ease-out 0.4s backwards;
        }

        
        .output-container {
            background-color: var(--tf2-ui-bg-darker);
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 120px;
            font-size: 16px;
            position: relative;
        }
        
        #output {
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 80px;
            transition: color 0.3s ease;
        }
        
        .char-counter {
            text-align: right;
            font-size: 12px;
            color: #888;
            margin-top: -15px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .char-counter.limit-exceeded {
            color: #ff4444;
        }

        textarea {
            width: 100%;
            height: 120px;
            background-color: var(--tf2-ui-bg-darker);
            color: var(--tf2-text);
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 10px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--tf2-ui-border);
            box-shadow: 0 0 10px rgba(255, 119, 0, 0.3);
        }

        .ui-panel h3 {
            color: var(--tf2-header);
            margin-top: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            font-size: 1.2rem;
        }
        
        .color-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .scrollable-section {
            max-height: 250px;
            overflow-y: auto;
            background-color: var(--tf2-ui-bg-darker);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .quality-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }

        .quality-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            filter: brightness(1.2);
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="color"] {
            width: 40px;
            height: 40px;
            border: 1px solid #444;
            cursor: pointer;
            padding: 0;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        input[type="color"]:hover {
            transform: scale(1.1);
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="text"], select {
            background-color: var(--tf2-ui-bg-darker);
            color: var(--tf2-text);
            border: 1px solid #444;
            border-radius: 3px;
            padding: 8px;
            font-family: 'Roboto Mono', monospace;
            width: 100px;
        }

        select {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: var(--tf2-ui-border);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
        }
        
        button:hover {
            background-color: var(--tf2-header);
            transform: scale(1.03);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        button:active {
            transform: scale(0.98);
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #444;
            color: #fff;
            padding: 5px 10px;
            font-size: 12px;
            font-family: 'Roboto Mono', monospace;
            letter-spacing: 0.5px;
            z-index: 10;
        }
        
        .copy-btn:hover {
            background-color: #666;
            transform: scale(1.05);
        }

        /* --- Modal Styling --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--tf2-ui-bg);
            border: 2px solid var(--tf2-ui-border);
            padding: 30px;
            border-radius: 5px;
            width: 400px;
            box-shadow: 0 0 20px rgba(255,119,0,0.4);
        }

        .modal-content h3 {
            margin-top: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: var(--tf2-header);
        }

        .modal-input-group input {
            width: 100%;
        }

        /* Rainbow Animation */
        .rainbow-text {
            background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Kitty-Core</h2>
        <nav>
            <ul>
                <li><a href="#" class="active">TF2 Chat Creator</a></li>
                <li><a href="https://kitty-core.github.io/clangen">Clangen Patrol Editor</a></li>
            </ul>
        </nav>

        <div class="history-section">
            <h3>History</h3>
            <ul class="history-list" id="history-list">
                </ul>
        </div>
    </div>

    <div class="main-content">
        <h1>TF2 Colored Chat Creator</h1>

        <div class="instructions">
            <h3>HOW DOES IT WORK!?</h3>
            <p>Type in the box, use the buttons to add color codes, then copy the text.
            <br>
            Paste it into the TF2 chat. <span class="special-char">NOTE: 127 character limit applies to the FINAL string.</span>
            </p>
        </div>
        
        <div class="app-grid">
            <div class="left-column">
                <div class="ui-panel">
                    <h3>Preview:</h3>
                    <div class="output-container">
                        <div id="output">Type something below to see your colored chat message!</div>
                        <button class="copy-btn" onclick="copyOutput()">Copy</button>
                    </div>
                    <div class="char-counter" id="char-counter">0 / 127</div>
                    <h3>Input:</h3>
                    <textarea id="message-input" placeholder="Type your message here..."></textarea>
                    <div class="action-buttons">
                        <button onclick="clearText()" style="background-color: #555;">Clear All</button>
                        <button onclick="openBindModal()">Generate Bind</button>
                        <button onclick="saveToHistory()" style="background-color: #444;">Save History</button>
                    </div>
                </div>

                <div class="ui-panel">
                    <h3>Gradient & Rainbow Tools:</h3>
                    <div class="color-picker-container">
                        <input type="color" id="grad-start" value="#FF0000">
                        <span>to</span>
                        <input type="color" id="grad-end" value="#0000FF">
                        <button onclick="applyGradient()">Gradient</button>
                    </div>
                    <button class="quality-btn" style="width: 100%; background: linear-gradient(to right, red, orange, yellow, green, blue, rgb(149, 0, 255), rgb(255, 74, 135));" onclick="applyRainbow()">
                        RAINBOW GENERATOR
                    </button>
                </div>
            </div>

            <div class="right-column">
                <div class="ui-panel">
                    <h3>Custom Color:</h3>
                    <div class="color-picker-container">
                        <input type="color" id="color-picker" value="#FF0000" onchange="updateHexInput()">
                        <span>#</span>
                        <input type="text" id="hex-input" value="FF0000" maxlength="6" pattern="[0-9A-Fa-f]{6}" onchange="updateColorPicker()">
                        <button onclick="insertCustomColor()">Insert</button>
                    </div>

                    <h3>Item Quality Colors:</h3>
                    <div class="color-section">
                        <button class="quality-btn" style="background-color: #FFD700" onclick="insertColor('FFD700', 'Unique')" title="Unique">Unique</button>
                        <button class="quality-btn" style="background-color: #476291" onclick="insertColor('476291', 'Vintage')" title="Vintage">Vintage</button>
                        <button class="quality-btn" style="background-color: #CF6A32" onclick="insertColor('CF6A32', 'Strange')" title="Strange">Strange</button>
                        <button class="quality-btn" style="background-color: #4D7455" onclick="insertColor('4D7455', 'Genuine')" title="Genuine">Genuine</button>
                        <button class="quality-btn" style="background-color: #38F3AB" onclick="insertColor('38F3AB', 'Haunted')" title="Haunted">Haunted</button>
                        <button class="quality-btn" style="background-color: #AA0000" onclick="insertColor('AA0000', 'Collector\'s')" title="Collector's">Collector's</button>
                        <button class="quality-btn" style="background-color: #FAFAFA; color: #333; text-shadow: none;" onclick="insertColor('FAFAFA', 'Decorated')" title="Decorated">Decorated</button>
                        <button class="quality-btn" style="background-color: #B2B2B2" onclick="insertColor('B2B2B2', 'Normal')" title="Normal">Normal</button>
                        <button class="quality-btn" style="background-color: #8650AC" onclick="insertColor('8650AC', 'Unusual')" title="Unusual">Unusual</button>
                        <button class="quality-btn" style="background-color: #70B04A" onclick="insertColor('70B04A', 'Community')" title="Community">Community</button>
                        <button class="quality-btn" style="background-color: #A50F79" onclick="insertColor('A50F79', 'Valve')" title="Valve">Valve</button>
                        <button class="quality-btn" style="background-color: #70B04A" onclick="insertColor('70B04A', 'Self-Made')" title="Self-Made">Self-Made</button>
                    </div>

                    <h3>Common Colors:</h3>
                    <div class="color-section">
                        <button class="quality-btn" style="background:#FBECCB; color: #333; text-shadow: none;" onclick="insertColor('FBECCB','RESET')" title="RESET (Default Chat Color)">RESET</button>
                        <button class="quality-btn" style="background:#FF0000" onclick="insertColor('FF0000','Red')" title="Red">Red</button>
                        <button class="quality-btn" style="background:#FFA500" onclick="insertColor('FFA500','Orange')" title="Orange">Orange</button>
                        <button class="quality-btn" style="background:#FFFF00; color: #333; text-shadow: none;" onclick="insertColor('FFFF00','Yellow')" title="Yellow">Yellow</button>
                        <button class="quality-btn" style="background:#00FF00" onclick="insertColor('00FF00','Green')" title="Green">Green</button>
                        <button class="quality-btn" style="background:#0000FF" onclick="insertColor('0000FF','Blue')" title="Blue">Blue</button>
                        <button class="quality-btn" style="background:#4B0082" onclick="insertColor('4B0082','Indigo')" title="Indigo">Indigo</button>
                        <button class="quality-btn" style="background:#EE82EE" onclick="insertColor('EE82EE','Violet')" title="Violet">Violet</button>
                        <button class="quality-btn" style="background:#FFAAAA" onclick="insertColor('FFAAAA','Pink')" title="Pink">Pink</button>
                    </div>

                    <h3>Teams & Other:</h3>
                    <div class="color-section">
                        <button class="quality-btn" style="background-color: #bd3b3b" onclick="insertColor('D55253', 'RED')" title="RED">RED</button>
                        <button class="quality-btn" style="background-color: #395c78" onclick="insertColor('AFD8FF', 'BLU')" title="BLU">BLU</button>
                        <button class="quality-btn" style="background-color: #9ec34f" onclick="insertColor('9ec34f', 'Achievement')" title="Achievement">Achievement</button>
                    </div>

                    <h3>Paints:</h3>
                    <div class="color-section scrollable-section">
                        <button class="quality-btn" style="background-color: #2F4F4F" onclick="insertColor('2F4F4F', 'A Color Similar to Slate')" title="A Color Similar to Slate">Slate</button>
                        <button class="quality-btn" style="background-color: #7D4071" onclick="insertColor('7D4071', 'A Deep Commitment to Purple')" title="A Deep Commitment to Purple">Purple</button>
                        <button class="quality-btn" style="background-color: #141414" onclick="insertColor('141414', 'A Distinctive Lack of Hue')" title="A Distinctive Lack of Hue">Black</button>
                        <button class="quality-btn" style="background-color: #BCDDB3; color: #333; text-shadow: none;" onclick="insertColor('BCDDB3', 'A Mann\'s Mint')" title="A Mann's Mint">Mint</button>
                        <button class="quality-btn" style="background-color: #2D2D24" onclick="insertColor('2D2D24', 'After Eight')" title="After Eight">After Eight</button>
                        <button class="quality-btn" style="background-color: #7E7E7E" onclick="insertColor('7E7E7E', 'Aged Moustache Grey')" title="Aged Moustache Grey">Grey</button>
                        <button class="quality-btn" style="background-color: #E6E6E6; color: #333; text-shadow: none;" onclick="insertColor('E6E6E6', 'An Extraordinary Abundance of Tinge')" title="An Extraordinary Abundance of Tinge">White</button>
                        <button class="quality-btn" style="background-color: #E7B53B" onclick="insertColor('E7B53B', 'Australium Gold')" title="Australium Gold">Australium</button>
                        <button class="quality-btn" style="background-color: #D8BED8; color: #333; text-shadow: none;" onclick="insertColor('D8BED8', 'Color No. 216-190-216')" title="Color No. 216-190-216">216-190-216</button>
                        <button class="quality-btn" style="background-color: #E9967A" onclick="insertColor('E9967A', 'Dark Salmon Injustice')" title="Dark Salmon Injustice">Salmon</button>
                        <button class="quality-btn" style="background-color: #808000" onclick="insertColor('808000', 'Drably Olive')" title="Drably Olive">Olive</button>
                        <button class="quality-btn" style="background-color: #729E42" onclick="insertColor('729E42', 'Indubitably Green')" title="Indubitably Green">Green</button>
                        <button class="quality-btn" style="background-color: #CF7336" onclick="insertColor('CF7336', 'Mann Co. Orange')" title="Mann Co. Orange">Mann Co.</button>
                        <button class="quality-btn" style="background-color: #A57545" onclick="insertColor('A57545', 'Muskelmannbraun')" title="Muskelmannbraun">Brown</button>
                        <button class="quality-btn" style="background-color: #51384A" onclick="insertColor('51384A', 'Noble Hatter\'s Violet')" title="Noble Hatter\'s Violet">Violet</button>
                        <button class="quality-btn" style="background-color: #C5AF91; color: #333; text-shadow: none;" onclick="insertColor('C5AF91', 'Peculiarly Drab Tincture')" title="Peculiarly Drab Tincture">Tincture</button>
                        <button class="quality-btn" style="background-color: #FF69B4" onclick="insertColor('FF69B4', 'Pink as Hell')" title="Pink as Hell">Pink</button>
                        <button class="quality-btn" style="background-color: #694D3A" onclick="insertColor('694D3A', 'Radigan Conagher Brown')" title="Radigan Conagher Brown">Conagher</button>
                        <button class="quality-btn" style="background-color: #32CD32" onclick="insertColor('32CD32', 'The Bitter Taste of Defeat and Lime')" title="The Bitter Taste of Defeat and Lime">Lime</button>
                        <button class="quality-btn" style="background-color: #F0E68C; color: #333; text-shadow: none;" onclick="insertColor('F0E68C', 'The Color of a Gentlemann\'s Business Pants')" title="The Color of a Gentlemann's Business Pants">Pants</button>
                        <button class="quality-btn" style="background-color: #7C6C57" onclick="insertColor('7C6C57', 'Ye Olde Rustic Colour')" title="Ye Olde Rustic Colour">Rustic</button>
                        <button class="quality-btn" style="background-color: #424F3B" onclick="insertColor('424F3B', 'Zepheniah\'s Greed')" title="Zepheniah's Greed">Greed</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bind-modal">
        <div class="modal-content">
            <h3>Bind Creator</h3>
            <div class="modal-input-group">
                <label>Key to Press:</label>
                <input type="text" id="bind-key" placeholder="e.g. k" maxlength="10">
            </div>
            <div class="modal-input-group">
                <label>Action Type:</label>
                <select id="bind-type">
                    <option value="say_team">Team Say (Recommended for colors)</option>
                    <option value="say">Kill + Public Say</option>
                </select>
            </div>
            <div class="modal-footer">
                <button onclick="closeBindModal()" style="background-color: #555;">Cancel</button>
                <button onclick="applyBind()">Apply</button>
            </div>
        </div>
    </div>
    
    <script>
        const messageInput = document.getElementById('message-input');
        const output = document.getElementById('output');
        const colorPicker = document.getElementById('color-picker');
        const hexInput = document.getElementById('hex-input');
        const charCounter = document.getElementById('char-counter');
        const historyList = document.getElementById('history-list');
        
        // Bell character (ASCII 7/hex 07)
        const BELL_CHAR = String.fromCharCode(7);
        const MAX_CHARS = 127;
        
        // Process text on input
        messageInput.addEventListener('input', processText);

        // Initial process
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            processText();
        });
        
        function processText() {
            const text = messageInput.value;
            const currentLen = text.length;
            
            // Character Counter Showcase
            charCounter.textContent = `${currentLen} / ${MAX_CHARS}`;
            if (currentLen > MAX_CHARS) {
                charCounter.classList.add('limit-exceeded');
            } else {
                charCounter.classList.remove('limit-exceeded');
            }

            // Regex to find: (Bell)color!(Bell)(6-char-hex)(the-text-to-color)
            const colorRegex = new RegExp(BELL_CHAR + "color!" + BELL_CHAR + "([0-9A-Fa-f]{6})([^" + BELL_CHAR + "]*)", "gi");
            
            output.innerHTML = '';
            let lastIndex = 0;
            let match;
            
            if (!text.includes(BELL_CHAR + "color!" + BELL_CHAR)) {
                output.textContent = text;
            } else {
                 while ((match = colorRegex.exec(text)) !== null) {
                    if (match.index > lastIndex) {
                        const plainText = document.createTextNode(text.substring(lastIndex, match.index));
                        output.appendChild(plainText);
                    }
                    
                    const colorCode = match[1];
                    const coloredText = match[2];
                    
                    const span = document.createElement('span');
                    span.style.color = `#${colorCode}`;
                    span.textContent = coloredText;
                    output.appendChild(span);
                    
                    lastIndex = colorRegex.lastIndex;
                }
                
                if (lastIndex < text.length) {
                    const plainText = document.createTextNode(text.substring(lastIndex));
                    output.appendChild(plainText);
                }
            }
            
            if (output.innerHTML === '') {
                output.textContent = 'Type something below to see your colored chat message!';
                output.style.color = '#888';
            } else {
                output.style.color = '';
            }
        }
        
        function insertColor(hexCode, qualityName) {
            const selectionStart = messageInput.selectionStart;
            const selectionEnd = messageInput.selectionEnd;
            const currentValue = messageInput.value;
            
            const colorTag = BELL_CHAR + "color!" + BELL_CHAR + hexCode;
            const selectedText = currentValue.substring(selectionStart, selectionEnd);
            
            let textToInsert = colorTag;
            if (selectedText) {
                textToInsert += selectedText;
            }
            
            const newText = currentValue.substring(0, selectionStart) + textToInsert + currentValue.substring(selectionEnd);
            messageInput.value = newText;
            messageInput.focus();
            
            let newPosition = selectedText ? selectionEnd + colorTag.length : selectionStart + colorTag.length;
            messageInput.setSelectionRange(newPosition, newPosition);
            processText();
        }

        /* --- Gradient Math & System --- */
        function applyGradient() {
            const text = messageInput.value || "Sample Text";
            const startColor = document.getElementById('grad-start').value;
            const endColor = document.getElementById('grad-end').value;
            
            // MATH: Keep under 127 limit
            // Each tag is 14 chars. \x07color!\x07RRGGBB
            // Max tags allowed = floor((127 - text_length) / 14)
            const availableCharsForTags = MAX_CHARS - text.length;
            const maxTags = Math.floor(availableCharsForTags / 14);

            if (maxTags <= 0) {
                alert("Text is too long to apply a gradient! Reduce text length.");
                return;
            }

            const numSteps = Math.min(text.length, maxTags);
            const stepSize = text.length / numSteps;
            let result = "";

            const startRGB = hexToRgb(startColor);
            const endRGB = hexToRgb(endColor);

            for (let i = 0; i < numSteps; i++) {
                const ratio = i / (numSteps - 1 || 1);
                const r = Math.round(startRGB.r + (endRGB.r - startRGB.r) * ratio);
                const g = Math.round(startRGB.g + (endRGB.g - startRGB.g) * ratio);
                const b = Math.round(startRGB.b + (endRGB.b - startRGB.b) * ratio);
                
                const hex = rgbToHex(r, g, b);
                const startIdx = Math.floor(i * stepSize);
                const endIdx = Math.floor((i + 1) * stepSize);
                const chunk = text.substring(startIdx, endIdx);
                
                result += BELL_CHAR + "color!" + BELL_CHAR + hex + chunk;
            }

            messageInput.value = result;
            processText();
        }

        function applyRainbow() {
            const text = messageInput.value || "RAINBOW!";
            const rainbowColors = [
                "#FF0000", "#FF7F00", "#FFFF00", "#00FF00", "#0000FF", "#CC22FF", "#FF7979"
            ];
            
            const availableCharsForTags = MAX_CHARS - text.length;
            const maxTags = Math.floor(availableCharsForTags / 14);
            const numSteps = Math.min(text.length, maxTags);
            const stepSize = text.length / numSteps;
            
            let result = "";
            for (let i = 0; i < numSteps; i++) {
                const colorIdx = Math.floor((i / numSteps) * rainbowColors.length);
                const hex = rainbowColors[colorIdx].substring(1);
                const startIdx = Math.floor(i * stepSize);
                const endIdx = Math.floor((i + 1) * stepSize);
                const chunk = text.substring(startIdx, endIdx);
                result += BELL_CHAR + "color!" + BELL_CHAR + hex + chunk;
            }
            messageInput.value = result;
            processText();
        }

        /* --- Bind GUI Modal Logic --- */
        function openBindModal() {
            document.getElementById('bind-modal').style.display = 'flex';
        }

        function closeBindModal() {
            document.getElementById('bind-modal').style.display = 'none';
        }

        function applyBind() {
            const key = document.getElementById('bind-key').value || "k";
            const type = document.getElementById('bind-type').value;
            let msg = messageInput.value;

            // Clean existing bind if user is re-binding
            msg = msg.replace(/^bind\s+\S+\s+"(say_team|say|explode; say_team)\s+/, "").replace(/"$/, "");

            let finalCommand = "";
            if (type === "say_team") finalCommand = `bind ${key} "say_team ${msg}"`;
            if (type === "say") finalCommand = `bind ${key} "kill ; say ${msg}"`;

            messageInput.value = finalCommand;
            closeBindModal();
            processText();
        }

        /* --- Cookie & History Logic --- */
        function saveToHistory() {
            const val = messageInput.value;
            if (!val.trim()) return;

            let history = getHistory();
            history = history.filter(h => h !== val); // Remove duplicate
            history.unshift(val);
            if (history.length > 10) history.pop();

            setCookie("chat_history", JSON.stringify(history), 30);
            renderHistory();
        }

        function loadHistory() {
            renderHistory();
        }

        function renderHistory() {
            const history = getHistory();
            historyList.innerHTML = '';
            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.textContent = item;
                li.title = "Click to load";
                li.onclick = () => {
                    messageInput.value = item;
                    processText();
                };
                historyList.appendChild(li);
            });
        }

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return decodeURIComponent(c.substring(nameEQ.length,c.length));
            }
            return null;
        }

        function getHistory() {
            const data = getCookie("chat_history");
            return data ? JSON.parse(data) : [];
        }

        /* --- Helpers --- */
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b };
        }

        function rgbToHex(r, g, b) {
            return [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('').toUpperCase();
        }
        
        function insertCustomColor() {
            insertColor(hexInput.value, 'Custom');
        }
        
        function updateHexInput() {
            hexInput.value = colorPicker.value.substring(1).toUpperCase();
        }
        
        function updateColorPicker() {
            let hex = hexInput.value.replace(/[^0-9A-Fa-f]/g, '');
            if (hex.length > 6) hex = hex.substring(0, 6);
            let paddedHex = hex.padEnd(6, '0');
            hexInput.value = hex.toUpperCase();
            colorPicker.value = `#${paddedHex}`;
        }
        
        function clearText() {
            messageInput.value = '';
            processText();
        }
        
        function copyOutput() {
            const outputText = messageInput.value;
            const copyButton = document.querySelector('.copy-btn');
            
            if (outputText.trim() === '') {
                copyButton.textContent = 'Nothing to copy!';
                copyButton.style.backgroundColor = '#aa0000';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                    copyButton.style.backgroundColor = '#444';
                }, 2000);
                return;
            }
            
            navigator.clipboard.writeText(outputText).then(() => {
                copyButton.textContent = 'Copied!';
                copyButton.style.backgroundColor = '#70B04A';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                    copyButton.style.backgroundColor = '#444';
                }, 2000);
            });
        }
    </script>
</body>
</html>
